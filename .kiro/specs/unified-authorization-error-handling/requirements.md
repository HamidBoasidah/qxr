# متطلبات: توحيد معالجة أخطاء الصلاحيات في API

## 1. نظرة عامة

### 1.1 الهدف
توحيد معالجة أخطاء الصلاحيات (Authorization) في جميع API endpoints لتقديم استجابات منسقة ومهنية عند محاولة الوصول إلى موارد غير مصرح بها، بدلاً من عرض stack trace كامل.

### 1.2 المشكلة الحالية
- عند محاولة تعديل أو حذف منتج غير مصرح به، يتم عرض `AccessDeniedHttpException` مع stack trace كامل
- في `AddressController`، يتم معالجة الأخطاء بشكل صحيح ويظهر رد منسق
- عدم توحيد طريقة معالجة أخطاار الصلاحيات عبر جميع الـ controllers

### 1.3 الحل المطلوب
معالجة أخطاء `authorize()` في `ProductController` بنفس الطريقة المستخدمة في `AddressController` لضمان استجابات منسقة وآمنة.

## 2. قصص المستخدم

### 2.1 كمستخدم API
أريد الحصول على رسالة خطأ واضحة ومنسقة عند محاولة الوصول إلى منتج غير مصرح لي بالوصول إليه، بدلاً من رؤية تفاصيل تقنية معقدة.

### 2.2 كمطور
أريد أن تكون جميع API endpoints متسقة في طريقة معالجة أخطاء الصلاحيات لتسهيل الصيانة والتطوير.

### 2.3 من منظور الأمان
يجب عدم الكشف عن معلومات حساسة (مثل وجود المورد من عدمه) عند رفض الصلاحية، لحماية خصوصية البيانات.

## 3. معايير القبول

### 3.1 معالجة أخطاء الصلاحيات في ProductController
- **معيار**: عند فشل `authorize()` في أي method في `ProductController`، يجب معالجة الاستثناء وإرجاع استجابة منسقة
- **السلوك المتوقع**: 
  - استخدام `try-catch` حول عمليات `authorize()`
  - رمي `NotFoundException` بدلاً من السماح لـ `AccessDeniedHttpException` بالظهور
  - الرسالة: "المنتج المطلوب غير موجود" (لأسباب أمنية)
- **الاستجابة المتوقعة**:
```json
{
  "success": false,
  "message": "المنتج المطلوب غير موجود",
  "error_code": "NOT_FOUND",
  "status_code": 404,
  "timestamp": "2026-02-12T16:57:27.196595Z"
}
```

### 3.2 تطبيق على جميع methods المحمية
- **Methods المتأثرة**: `update()`, `destroy()`, `activate()`, `deactivate()`
- **معيار**: كل method يستخدم `authorize()` يجب أن يعالج الاستثناء بشكل صحيح

### 3.3 الحفاظ على الأمان
- **معيار**: عدم الكشف عن وجود المورد من عدمه عند رفض الصلاحية
- **السلوك**: إرجاع نفس الرسالة "المنتج المطلوب غير موجود" سواء كان المنتج غير موجود أو غير مصرح بالوصول إليه

### 3.4 الاتساق مع AddressController
- **معيار**: يجب أن تكون طريقة المعالجة مطابقة لما هو مستخدم في `AddressController`
- **التحقق**: مراجعة الكود للتأكد من التطابق في الأسلوب

## 4. القيود والافتراضات

### 4.1 القيود
- يجب عدم تغيير سلوك `Handler.php` الحالي
- يجب الحفاظ على جميع الـ policies الموجودة دون تعديل
- يجب عدم التأثير على أي controller آخر

### 4.2 الافتراضات
- `ExceptionHandler` trait متاح ويعمل بشكل صحيح
- `NotFoundException` يتم معالجته بشكل صحيح في `Handler.php`
- الـ policies الحالية تعمل بشكل صحيح

## 5. الاعتبارات الفنية

### 5.1 معالجة الاستثناءات
- استخدام `Illuminate\Auth\Access\AuthorizationException` للإمساك بأخطاء الصلاحيات
- تحويل `AuthorizationException` إلى `NotFoundException` للأمان

### 5.2 ترتيب العمليات
في كل method محمي:
1. محاولة جلب المورد (`findOrFail`)
2. معالجة `ModelNotFoundException` إذا لم يوجد المورد
3. محاولة التحقق من الصلاحية (`authorize`)
4. معالجة `AuthorizationException` وتحويلها لـ `NotFoundException`
5. تنفيذ العملية المطلوبة

### 5.3 الأداء
- لا يوجد تأثير على الأداء (نفس عدد الاستعلامات)
- فقط إضافة معالجة استثناءات

## 6. معايير النجاح

### 6.1 الاختبار اليدوي
- محاولة تعديل منتج لا يملكه المستخدم → يجب إرجاع 404 مع رسالة منسقة
- محاولة حذف منتج لا يملكه المستخدم → يجب إرجاع 404 مع رسالة منسقة
- محاولة تفعيل/تعطيل منتج لا يملكه المستخدم → يجب إرجاع 404 مع رسالة منسقة

### 6.2 عدم وجود stack trace
- التأكد من عدم ظهور أي stack trace في الاستجابة
- التأكد من عدم الكشف عن معلومات حساسة

### 6.3 الاتساق
- جميع الاستجابات يجب أن تتبع نفس الهيكل المستخدم في `AddressController`

## 7. خارج النطاق

- تعديل controllers أخرى غير `ProductController`
- تعديل `Handler.php` أو الـ exception classes
- تعديل الـ policies
- إضافة اختبارات آلية (يمكن إضافتها لاحقاً)
